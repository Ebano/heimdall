<!doctype html><html lang=en><head><title>Envoy Integration</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Heimdall is an open source identity aware proxy (IAP) and access control decision service, designed for cloud native applications"><meta name=dc.relation content="https://dadrus.github.io/"><meta name=theme-color content="#1A94D2"><link rel=stylesheet href=../../../css/styles.min.css media=screen><link rel='shortcut icon' type=image/x-icon href=../../../favicon.ico></head><body><header class="navbar navbar-expand-md navbar-dark bg-dark sticky-top"><nav class="container-xxl flex-wrap flex-lg-nowrap" aria-label="Main navigation"><a class="navbar-brand text-white" href=../../../>Heimdall</a>
<button class=navbar-toggler type=button data-bs-toggle=offcanvas data-bs-target=#mainMenuContent aria-controls=mainMenuContent aria-expanded=false aria-label="Open main menu">
<span class=navbar-toggler-icon></span></button><div class="offcanvas offcanvas-end bg-dark" tabindex=-1 id=mainMenuContent data-bs-scroll=true aria-labelledby=mainMenuContentLabel><div class=offcanvas-header><h4 class="offcanvas-title text-white" id=mainMenuContentLabel>Heimdall</h4><button type=button class="btn-close btn-close-white" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class=offcanvas-body><ul class="navbar-nav flex-column flex-md-row"><li class=nav-item><a class='nav-link text-white' href=../../../docs/welcome>Docs</a></li><li class=nav-item><a class='nav-link text-white' href=../../../openapi/>API</a></li><li class="nav-item dropdown"><a class='nav-link dropdown-toggle text-white' href=# id="Get Started-navbarDropdown" role=button data-bs-toggle=dropdown aria-expanded=false>Get Started</a><ul class="dropdown-menu bg-dark" aria-labelledby="Get Started-navbarDropdown"><li><a class='dropdown-item text-white' href=../../../docs/getting_started/concepts/>Concepts</a></li><li><a class='dropdown-item text-white' href=../../../docs/getting_started/decision_service_quickstart/>Decision Service Quickstart</a></li><li><a class='dropdown-item text-white' href=../../../docs/getting_started/proxy_service_quickstart/>Proxy Service Quickstart</a></li></ul></li></ul><hr class="text-white-50 d-md-none"><ul class="navbar-nav flex-column ms-auto"><doc-version-select class="nav-item dropdown" version-file=/heimdall/data.json current-version=v0.11.0-alpha current-page=/docs/guides/envoy/><button class="btn btn-dark dropdown-toggle me-4" data-bs-toggle=dropdown aria-expanded=false>
v0.11.0-alpha</button></doc-version-select></ul><ul class="navbar-nav flex-column"><li class="nav-item mb-1"><a class="nav-link text-white" href=https://github.com/dadrus/heimdall><svg xmlns="http://www.w3.org/2000/svg" role="img" width="20" height="20" fill="currentcolor" class="bi bi-github text-white" viewBox="0 0 16 16"><title>GitHub</title><path d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.012 8.012.0 0016 8c0-4.42-3.58-8-8-8z"/></svg><small class="ms-2 d-md-none">GitHub</small></a></li></ul></div></div></nav></header><nav class="navbar navbar-expand-lg bg-light" aria-label="Docs menu"><div class=container-xxl><div class="row container-fluid"><doc-search class="col-auto me-auto" index-file=/heimdall/v0.11.0-alpha/index.json path-prefix=/heimdall/v0.11.0-alpha><form id=docs-search tabindex=1 class="doks-search position-relative me-auto"><input id=search class="form-control search-bar" type=search placeholder="Search docs..." aria-label="Search docs..." autocomplete=off><div id=search-suggestions class="shadow bg-white rounded collapse search-results"></div></form></doc-search><button class="col-auto navbar-toggler" type=button data-bs-toggle=collapse data-bs-target=#docsMenuContent aria-controls=docsMenuContent aria-expanded=false aria-label="Open docs menu"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-arrow-down-up" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.5 15a.5.5.0 00.5-.5V2.707l3.146 3.147a.5.5.0 00.708-.708l-4-4a.5.5.0 00-.708.0l-4 4a.5.5.0 10.708.708L11 2.707V14.5a.5.5.0 00.5.5zm-7-14a.5.5.0 01.5.5v11.793l3.146-3.147a.5.5.0 01.708.708l-4 4a.5.5.0 01-.708.0l-4-4a.5.5.0 01.708-.708L4 13.293V1.5a.5.5.0 01.5-.5z"/></svg></button></div><div class="row d-md-none"><div class="col-2 collapse navbar-collapse" id=docsMenuContent><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../docs/welcome/>Welcome</a></li><li class=nav-item><button class="btn btn-toggle align-items-center rounded collapsed fw-bold border-0" data-bs-toggle=collapse data-bs-target=#section-010b85ad56b34c34c7c2a3b2436c740e30428ed5 aria-expanded=false>
Getting Started</button><div id=section-010b85ad56b34c34c7c2a3b2436c740e30428ed5 class=collapse><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../docs/getting_started/concepts/>Concepts</a></li><li class=nav-item><a class=nav-link href=../../../docs/getting_started/decision_service_quickstart/>Decision Service Quickstart</a></li><li class=nav-item><a class=nav-link href=../../../docs/getting_started/proxy_service_quickstart/>Proxy Service Quickstart</a></li><li class=nav-item><a class=nav-link href=../../../docs/getting_started/configuration_introduction/>Configuration Introduction</a></li></ul></div></li><li class=nav-item><button class="btn btn-toggle align-items-center rounded collapsed fw-bold border-0" data-bs-toggle=collapse data-bs-target=#section-a1fdaa6b2a846c8fcf18d414bf8c61db610eda6a aria-expanded=false>
Operations</button><div id=section-a1fdaa6b2a846c8fcf18d414bf8c61db610eda6a class=collapse><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../docs/operations/install/>Install</a></li><li class=nav-item><a class=nav-link href=../../../docs/operations/cli/>CLI</a></li><li class=nav-item><a class=nav-link href=../../../docs/operations/observability/>Observability</a></li><li class=nav-item><a class=nav-link href=../../../docs/operations/security/>Security</a></li></ul></div></li><li class=nav-item><button class="btn btn-toggle align-items-center rounded collapsed fw-bold border-0" data-bs-toggle=collapse data-bs-target=#section-929a28d261428029e61c0f81c6161fd71ba0b2fe aria-expanded=true>
Guides</button><div id=section-929a28d261428029e61c0f81c6161fd71ba0b2fe class="collapse show"><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../docs/guides/traefik/>Traefik Proxy Integration</a></li><li class=nav-item><a class=nav-link href=../../../docs/guides/nginx/>NGINX Integration</a></li><li class=nav-item><a class="nav-link fw-bold" href=../../../docs/guides/envoy/>Envoy Integration</a></li><li class=nav-item><a class=nav-link href=../../../docs/guides/opa/>Integration with OPA</a></li><li class=nav-item><a class=nav-link href=../../../docs/guides/contour/>Contour Integration</a></li></ul></div></li><li class=nav-item><button class="btn btn-toggle align-items-center rounded collapsed fw-bold border-0" data-bs-toggle=collapse data-bs-target=#section-754164850f38c1ecdaf6b8ed894cb192bc36c5f4 aria-expanded=false>
Configuration</button><div id=section-754164850f38c1ecdaf6b8ed894cb192bc36c5f4 class=collapse><ul class="nav flex-column"><li class=nav-item><button class="btn btn-toggle align-items-center rounded collapsed fw-bold border-0" data-bs-toggle=collapse data-bs-target=#section-5cbd584046863bc7b753e57e8681a98a87f36f0f aria-expanded=false>
Services</button><div id=section-5cbd584046863bc7b753e57e8681a98a87f36f0f class=collapse><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../docs/configuration/services/decision/>Decision</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/services/proxy/>Proxy</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/services/management/>Management</a></li></ul></div></li><li class=nav-item><button class="btn btn-toggle align-items-center rounded collapsed fw-bold border-0" data-bs-toggle=collapse data-bs-target=#section-e2397377af6d698b0fb66f53c47349a85bd2cb00 aria-expanded=false>
Observability</button><div id=section-e2397377af6d698b0fb66f53c47349a85bd2cb00 class=collapse><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../docs/configuration/observability/logging/>Logging</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/observability/metrics/>Metrics</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/observability/tracing/>Tracing</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/observability/profiling/>Runtime Profiling</a></li></ul></div></li><li class=nav-item><button class="btn btn-toggle align-items-center rounded collapsed fw-bold border-0" data-bs-toggle=collapse data-bs-target=#section-bb11a8e3f8712e36e7cd9d1c615a4e3dbb03336a aria-expanded=false>
Rules</button><div id=section-bb11a8e3f8712e36e7cd9d1c615a4e3dbb03336a class=collapse><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../docs/configuration/rules/overview/>Rules Overview</a></li><li class=nav-item><button class="btn btn-toggle align-items-center rounded collapsed fw-bold border-0" data-bs-toggle=collapse data-bs-target=#section-83ebcaaac1209f17a08fa17b9b1837aca7b222f7 aria-expanded=false>
Pipeline Mechanisms</button><div id=section-83ebcaaac1209f17a08fa17b9b1837aca7b222f7 class=collapse><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../docs/configuration/rules/pipeline_mechanisms/overview/>Mechanisms Overview</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/rules/pipeline_mechanisms/authenticators/>Authenticators</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/rules/pipeline_mechanisms/authorizers/>Authorizers</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/rules/pipeline_mechanisms/contextualizers/>Contextualizers</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/rules/pipeline_mechanisms/unifiers/>Unifiers</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/rules/pipeline_mechanisms/error_handlers/>Error Handlers</a></li></ul></div></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/rules/configuration/>Rule</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/rules/default/>Default Rule</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/rules/providers/>Rule Providers</a></li></ul></div></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/cryptographic_material/>Cryptographic Material</a></li><li class=nav-item><button class="btn btn-toggle align-items-center rounded collapsed fw-bold border-0" data-bs-toggle=collapse data-bs-target=#section-db1c784524e1b54011a95823026161f7c8517fe0 aria-expanded=false>
Reference</button><div id=section-db1c784524e1b54011a95823026161f7c8517fe0 class=collapse><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../docs/configuration/reference/types/>Configuration Types</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/reference/reference/>Static Configuration Reference</a></li></ul></div></li></ul></div></li></ul></div></div></div></nav><div class="container-xxl d-xxl-flex"><aside class="d-none d-md-block pe-4 pt-4 flex-xxl-shrink-0"><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../docs/welcome/>Welcome</a></li><li class=nav-item><button class="btn btn-toggle align-items-center rounded collapsed fw-bold border-0" data-bs-toggle=collapse data-bs-target=#section-010b85ad56b34c34c7c2a3b2436c740e30428ed5 aria-expanded=false>
Getting Started</button><div id=section-010b85ad56b34c34c7c2a3b2436c740e30428ed5 class=collapse><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../docs/getting_started/concepts/>Concepts</a></li><li class=nav-item><a class=nav-link href=../../../docs/getting_started/decision_service_quickstart/>Decision Service Quickstart</a></li><li class=nav-item><a class=nav-link href=../../../docs/getting_started/proxy_service_quickstart/>Proxy Service Quickstart</a></li><li class=nav-item><a class=nav-link href=../../../docs/getting_started/configuration_introduction/>Configuration Introduction</a></li></ul></div></li><li class=nav-item><button class="btn btn-toggle align-items-center rounded collapsed fw-bold border-0" data-bs-toggle=collapse data-bs-target=#section-a1fdaa6b2a846c8fcf18d414bf8c61db610eda6a aria-expanded=false>
Operations</button><div id=section-a1fdaa6b2a846c8fcf18d414bf8c61db610eda6a class=collapse><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../docs/operations/install/>Install</a></li><li class=nav-item><a class=nav-link href=../../../docs/operations/cli/>CLI</a></li><li class=nav-item><a class=nav-link href=../../../docs/operations/observability/>Observability</a></li><li class=nav-item><a class=nav-link href=../../../docs/operations/security/>Security</a></li></ul></div></li><li class=nav-item><button class="btn btn-toggle align-items-center rounded collapsed fw-bold border-0" data-bs-toggle=collapse data-bs-target=#section-929a28d261428029e61c0f81c6161fd71ba0b2fe aria-expanded=true>
Guides</button><div id=section-929a28d261428029e61c0f81c6161fd71ba0b2fe class="collapse show"><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../docs/guides/traefik/>Traefik Proxy Integration</a></li><li class=nav-item><a class=nav-link href=../../../docs/guides/nginx/>NGINX Integration</a></li><li class=nav-item><a class="nav-link fw-bold" href=../../../docs/guides/envoy/>Envoy Integration</a></li><li class=nav-item><a class=nav-link href=../../../docs/guides/opa/>Integration with OPA</a></li><li class=nav-item><a class=nav-link href=../../../docs/guides/contour/>Contour Integration</a></li></ul></div></li><li class=nav-item><button class="btn btn-toggle align-items-center rounded collapsed fw-bold border-0" data-bs-toggle=collapse data-bs-target=#section-754164850f38c1ecdaf6b8ed894cb192bc36c5f4 aria-expanded=false>
Configuration</button><div id=section-754164850f38c1ecdaf6b8ed894cb192bc36c5f4 class=collapse><ul class="nav flex-column"><li class=nav-item><button class="btn btn-toggle align-items-center rounded collapsed fw-bold border-0" data-bs-toggle=collapse data-bs-target=#section-5cbd584046863bc7b753e57e8681a98a87f36f0f aria-expanded=false>
Services</button><div id=section-5cbd584046863bc7b753e57e8681a98a87f36f0f class=collapse><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../docs/configuration/services/decision/>Decision</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/services/proxy/>Proxy</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/services/management/>Management</a></li></ul></div></li><li class=nav-item><button class="btn btn-toggle align-items-center rounded collapsed fw-bold border-0" data-bs-toggle=collapse data-bs-target=#section-e2397377af6d698b0fb66f53c47349a85bd2cb00 aria-expanded=false>
Observability</button><div id=section-e2397377af6d698b0fb66f53c47349a85bd2cb00 class=collapse><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../docs/configuration/observability/logging/>Logging</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/observability/metrics/>Metrics</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/observability/tracing/>Tracing</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/observability/profiling/>Runtime Profiling</a></li></ul></div></li><li class=nav-item><button class="btn btn-toggle align-items-center rounded collapsed fw-bold border-0" data-bs-toggle=collapse data-bs-target=#section-bb11a8e3f8712e36e7cd9d1c615a4e3dbb03336a aria-expanded=false>
Rules</button><div id=section-bb11a8e3f8712e36e7cd9d1c615a4e3dbb03336a class=collapse><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../docs/configuration/rules/overview/>Rules Overview</a></li><li class=nav-item><button class="btn btn-toggle align-items-center rounded collapsed fw-bold border-0" data-bs-toggle=collapse data-bs-target=#section-83ebcaaac1209f17a08fa17b9b1837aca7b222f7 aria-expanded=false>
Pipeline Mechanisms</button><div id=section-83ebcaaac1209f17a08fa17b9b1837aca7b222f7 class=collapse><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../docs/configuration/rules/pipeline_mechanisms/overview/>Mechanisms Overview</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/rules/pipeline_mechanisms/authenticators/>Authenticators</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/rules/pipeline_mechanisms/authorizers/>Authorizers</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/rules/pipeline_mechanisms/contextualizers/>Contextualizers</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/rules/pipeline_mechanisms/unifiers/>Unifiers</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/rules/pipeline_mechanisms/error_handlers/>Error Handlers</a></li></ul></div></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/rules/configuration/>Rule</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/rules/default/>Default Rule</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/rules/providers/>Rule Providers</a></li></ul></div></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/cryptographic_material/>Cryptographic Material</a></li><li class=nav-item><button class="btn btn-toggle align-items-center rounded collapsed fw-bold border-0" data-bs-toggle=collapse data-bs-target=#section-db1c784524e1b54011a95823026161f7c8517fe0 aria-expanded=false>
Reference</button><div id=section-db1c784524e1b54011a95823026161f7c8517fe0 class=collapse><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../docs/configuration/reference/types/>Configuration Types</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/reference/reference/>Static Configuration Reference</a></li></ul></div></li></ul></div></li></ul></aside><main class="px-3 pt-4 flex-xxl-grow-0"><h1>Envoy Integration</h1><div><div class=paragraph><p><a href=https://www.envoyproxy.io/>Envoy</a> is a high performance distributed proxy designed for single services and applications, as well as a communication bus and “universal data plane” designed for large microservice “service mesh” architectures. When operating heimdall in <a href=../../../docs/getting_started/concepts/#_decision_mode>Decision Operation Mode</a>, integration with Envoy can be achieved by making use of an <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/http/ext_authz/v3/ext_authz.proto.html>External Authorization</a> filter. In such setup, Envoy delegates authentication and authorization to heimdall. If heimdall answers with a <code>200 OK</code> HTTP code, Envoy grants access and forwards the original request to the upstream service. Otherwise, the response from heimdall is treated as an error and is returned to the client.</p></div><div class=paragraph><p>To achieve this, configure Envoy</p></div><div class=ulist><ul><li><p>to have heimdall instances referenced in a <code>cluster</code></p><div class=paragraph><p>Following snippet provides an example on how to create a <code>cluster</code> instance referencing heimdall. It assumes, you have just one heimdall instance deployed, which is also available via <code>heimdall</code> DNS name.</p></div><div class=listingblock><div class=content><pre class="rouge highlight" style=color:#fff;background-color:#272822><code data-lang=yaml><span style=color:#a6e22e>clusters</span><span style=color:#fff;background-color:#272822>:</span>
  <span style=color:#75715e># other cluster entries</span>
  <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>name</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>ext-authz</span>
    <span style=color:#a6e22e>type</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>strict_dns</span>
    <span style=color:#a6e22e>load_assignment</span><span style=color:#fff;background-color:#272822>:</span>
      <span style=color:#a6e22e>cluster_name</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>ext-authz</span>
      <span style=color:#a6e22e>endpoints</span><span style=color:#fff;background-color:#272822>:</span>
        <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>lb_endpoints</span><span style=color:#fff;background-color:#272822>:</span>
            <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>endpoint</span><span style=color:#fff;background-color:#272822>:</span>
                <span style=color:#a6e22e>address</span><span style=color:#fff;background-color:#272822>:</span>
                  <span style=color:#a6e22e>socket_address</span><span style=color:#fff;background-color:#272822>:</span>
                    <span style=color:#a6e22e>address</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>heimdall</span>
                    <span style=color:#a6e22e>port_value</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#ae81ff>4456</span>
  <span style=color:#75715e># other cluster entries</span></code></pre></div></div><div class=paragraph><p>If you want to integrate via Envoy’s <code>grpc_service</code> (see below), the cluster entry from above must have <code>http2_protocol_options</code> configured, as otherwise envoy will use HTTP 1 for GRPC communication, which is actually not allowed by GRPC (only HTTP 2 is supported). Here is an updated snipped:</p></div><div class=listingblock><div class=content><pre class="rouge highlight" style=color:#fff;background-color:#272822><code data-lang=yaml><span style=color:#a6e22e>clusters</span><span style=color:#fff;background-color:#272822>:</span>
  <span style=color:#75715e># other cluster entries</span>
  <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>name</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>ext-authz</span>
    <span style=color:#a6e22e>type</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>strict_dns</span>
    <span style=color:#a6e22e>typed_extension_protocol_options</span><span style=color:#fff;background-color:#272822>:</span>
      <span style=color:#a6e22e>envoy.extensions.upstreams.http.v3.HttpProtocolOptions</span><span style=color:#fff;background-color:#272822>:</span>
        <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>@type&#34;</span><span style=color:#960050>:</span> <span style=color:#e6db74>type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions</span>
        <span style=color:#e6db74>explicit_http_config</span><span style=color:#960050>:</span>
          <span style=color:#a6e22e>http2_protocol_options</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#fff;background-color:#272822>{}</span>
    <span style=color:#a6e22e>load_assignment</span><span style=color:#fff;background-color:#272822>:</span>
      <span style=color:#a6e22e>cluster_name</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>ext-authz</span>
      <span style=color:#a6e22e>endpoints</span><span style=color:#fff;background-color:#272822>:</span>
        <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>lb_endpoints</span><span style=color:#fff;background-color:#272822>:</span>
            <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>endpoint</span><span style=color:#fff;background-color:#272822>:</span>
                <span style=color:#a6e22e>address</span><span style=color:#fff;background-color:#272822>:</span>
                  <span style=color:#a6e22e>socket_address</span><span style=color:#fff;background-color:#272822>:</span>
                    <span style=color:#a6e22e>address</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>heimdall</span>
                    <span style=color:#a6e22e>port_value</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#ae81ff>4456</span>
  <span style=color:#75715e># other cluster entries</span></code></pre></div></div></li><li><p>to include an <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/http/ext_authz/v3/ext_authz.proto.html>External Authorization</a> HTTP filter in the definition of the HTTP connection manager and depending on the used configuration, either configure the <code>http_service</code> and let it contain the required header name(s), heimdall sets in the HTTP responses (depends on your <a href=../../../docs/configuration/rules/pipeline_mechanisms/contextualizers/>Contextualizers</a> and <a href=../../../docs/configuration/rules/pipeline_mechanisms/unifiers/>Unifiers</a> configuration), or configure the <code>grpc_service</code>.</p><div class=paragraph><p>The following snipped shows, how an <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/http/ext_authz/v3/ext_authz.proto.html>External Authorization</a> can be defined using <code>http_service</code> to let Envoy communicating with heimdall by making use of the previously defined <code>cluster</code> (see snippet from above) as well as forwarding all request headers to heimdall and to let it forward headers, set by heimdall in its responses (here the <code>Authorization</code> header) to the upstream services.</p></div><div class=listingblock><div class=content><pre class="rouge highlight" style=color:#fff;background-color:#272822><code data-lang=yaml><span style=color:#a6e22e>http_filters</span><span style=color:#fff;background-color:#272822>:</span>
  <span style=color:#75715e># other http filter</span>
  <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>name</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>envoy.filters.http.ext_authz</span>
    <span style=color:#a6e22e>typed_config</span><span style=color:#fff;background-color:#272822>:</span>
      <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>@type&#34;</span><span style=color:#960050>:</span> <span style=color:#e6db74>type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz</span>
      <span style=color:#e6db74>transport_api_version</span><span style=color:#960050>:</span> <span style=color:#e6db74>V3</span>
      <span style=color:#e6db74>http_service</span><span style=color:#960050>:</span>
        <span style=color:#a6e22e>server_uri</span><span style=color:#fff;background-color:#272822>:</span>
          <span style=color:#a6e22e>uri</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>heimdall:4456</span>
          <span style=color:#a6e22e>cluster</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>ext-authz</span>
          <span style=color:#a6e22e>timeout</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>0.25s</span>
        <span style=color:#a6e22e>authorization_request</span><span style=color:#fff;background-color:#272822>:</span>
          <span style=color:#a6e22e>allowed_headers</span><span style=color:#fff;background-color:#272822>:</span>
            <span style=color:#a6e22e>patterns</span><span style=color:#fff;background-color:#272822>:</span>
              <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>safe_regex</span><span style=color:#fff;background-color:#272822>:</span>
                  <span style=color:#a6e22e>google_re2</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#fff;background-color:#272822>{}</span>
                  <span style=color:#a6e22e>regex</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>.*&#34;</span>
        <span style=color:#a6e22e>authorization_response</span><span style=color:#fff;background-color:#272822>:</span>
          <span style=color:#a6e22e>allowed_upstream_headers</span><span style=color:#fff;background-color:#272822>:</span>
            <span style=color:#a6e22e>patterns</span><span style=color:#fff;background-color:#272822>:</span>
              <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>exact</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>authorization</span>
  <span style=color:#75715e># other http filter</span></code></pre></div></div><div class=paragraph><p>The following snipped shows, how an <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/http/ext_authz/v3/ext_authz.proto.html>External Authorization</a> can be defined using <code>grpc_service</code> to let Envoy communicating with heimdall by making use of the previously defined <code>cluster</code> (see snippet from above). In that configuration envoy by default forwards all request header to heimdall and also forwards headers, set by heimdall in its responses to the upstream services.</p></div><div class=listingblock><div class=content><pre class="rouge highlight" style=color:#fff;background-color:#272822><code data-lang=yaml><span style=color:#a6e22e>http_filters</span><span style=color:#fff;background-color:#272822>:</span>
  <span style=color:#75715e># other http filter</span>
  <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>name</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>envoy.filters.http.ext_authz</span>
    <span style=color:#a6e22e>typed_config</span><span style=color:#fff;background-color:#272822>:</span>
      <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>@type&#34;</span><span style=color:#960050>:</span> <span style=color:#e6db74>type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz</span>
      <span style=color:#e6db74>transport_api_version</span><span style=color:#960050>:</span> <span style=color:#e6db74>V3</span>
      <span style=color:#e6db74>grpc_service</span><span style=color:#960050>:</span>
        <span style=color:#a6e22e>envoy_grpc</span><span style=color:#fff;background-color:#272822>:</span>
          <span style=color:#a6e22e>cluster_name</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>ext-authz</span>
  <span style=color:#75715e># other http filter</span></code></pre></div></div></li></ul></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>Envoy does not set <code>X-Forwarded-*</code> headers, as long as the <code>envoy.filters.http.dynamic_forward_proxy</code> is not configured. In such cases matching of URLs happens based on those URLs, used by Envoy while communicating with heimdall. That means your rules should ignore the scheme and host parts, respectively use the values specific for heimdall and not of the domain.</td></tr></tbody></table></div><div class=sect1><h2 id=_demo_setup>Demo Setup</h2><div class=sectionbody><div class=paragraph><p>The Envoy configuration file shown below can be used to create a fully working setup based on the <a href=../../../docs/getting_started/decision_service_quickstart/>Decision Service Quickstart</a>. Just update the <code>docker-compose.yaml</code> file used in that guide and replace the entry for <code>proxy</code> service, with the one shown below. You can also remove all <code>labels</code> configurations, as these will have no effect.</p></div><div class=listingblock><div class=content><pre class="rouge highlight" style=color:#fff;background-color:#272822><code data-lang=yaml><span style=color:#75715e># docker-compose.yaml</span>

<span style=color:#a6e22e>services</span><span style=color:#fff;background-color:#272822>:</span>
  <span style=color:#a6e22e>proxy</span><span style=color:#fff;background-color:#272822>:</span>
    <span style=color:#a6e22e>image</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>envoyproxy/envoy:v1.24.1</span>
    <span style=color:#a6e22e>volumes</span><span style=color:#fff;background-color:#272822>:</span>
      <span style=color:#fff;background-color:#272822>-</span> <span style=color:#e6db74>./envoy.yaml:/envoy.yaml:ro</span>
    <span style=color:#a6e22e>ports</span><span style=color:#fff;background-color:#272822>:</span>
      <span style=color:#fff;background-color:#272822>-</span> <span style=color:#e6db74>9090:9090</span>
    <span style=color:#a6e22e>command</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>-c /envoy.yaml</span>

  <span style=color:#75715e># other services from the guide</span></code></pre></div></div><div class=listingblock><div class=content><pre class="rouge highlight" style=color:#fff;background-color:#272822><code data-lang=yaml><span style=color:#75715e># envoy.yaml</span>

<span style=color:#a6e22e>static_resources</span><span style=color:#fff;background-color:#272822>:</span>
  <span style=color:#a6e22e>listeners</span><span style=color:#fff;background-color:#272822>:</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>name</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>listener_0</span>
      <span style=color:#a6e22e>address</span><span style=color:#fff;background-color:#272822>:</span>
        <span style=color:#a6e22e>socket_address</span><span style=color:#fff;background-color:#272822>:</span>
          <span style=color:#a6e22e>address</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>0.0.0.0</span>
          <span style=color:#a6e22e>port_value</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#ae81ff>9090</span>
      <span style=color:#a6e22e>filter_chains</span><span style=color:#fff;background-color:#272822>:</span>
        <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>filters</span><span style=color:#fff;background-color:#272822>:</span>
          <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>name</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>envoy.filters.network.http_connection_manager</span>
            <span style=color:#a6e22e>typed_config</span><span style=color:#fff;background-color:#272822>:</span>
              <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>@type&#34;</span><span style=color:#960050>:</span> <span style=color:#e6db74>type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager</span>
              <span style=color:#e6db74>stat_prefix</span><span style=color:#960050>:</span> <span style=color:#e6db74>edge</span>
              <span style=color:#e6db74>http_filters</span><span style=color:#960050>:</span>
                <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>name</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>envoy.filters.http.ext_authz</span>
                  <span style=color:#a6e22e>typed_config</span><span style=color:#fff;background-color:#272822>:</span>
                    <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>@type&#34;</span><span style=color:#960050>:</span> <span style=color:#e6db74>type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz</span>
                    <span style=color:#e6db74>transport_api_version</span><span style=color:#960050>:</span> <span style=color:#e6db74>V3</span>
                    <span style=color:#e6db74>http_service</span><span style=color:#960050>:</span>
                      <span style=color:#a6e22e>server_uri</span><span style=color:#fff;background-color:#272822>:</span>
                        <span style=color:#a6e22e>uri</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>heimdall:4456</span>
                        <span style=color:#a6e22e>cluster</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>ext-authz</span>
                        <span style=color:#a6e22e>timeout</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>0.25s</span>
                      <span style=color:#a6e22e>authorization_request</span><span style=color:#fff;background-color:#272822>:</span>
                        <span style=color:#a6e22e>allowed_headers</span><span style=color:#fff;background-color:#272822>:</span>
                          <span style=color:#a6e22e>patterns</span><span style=color:#fff;background-color:#272822>:</span>
                            <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>safe_regex</span><span style=color:#fff;background-color:#272822>:</span>
                                <span style=color:#a6e22e>google_re2</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#fff;background-color:#272822>{}</span>
                                <span style=color:#a6e22e>regex</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>.*&#34;</span>
                      <span style=color:#a6e22e>authorization_response</span><span style=color:#fff;background-color:#272822>:</span>
                        <span style=color:#a6e22e>allowed_upstream_headers</span><span style=color:#fff;background-color:#272822>:</span>
                          <span style=color:#a6e22e>patterns</span><span style=color:#fff;background-color:#272822>:</span>
                            <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>exact</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>authorization</span>
                <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>name</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>envoy.filters.http.router</span>
                  <span style=color:#a6e22e>typed_config</span><span style=color:#fff;background-color:#272822>:</span>
                    <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>@type&#34;</span><span style=color:#960050>:</span> <span style=color:#e6db74>type.googleapis.com/envoy.extensions.filters.http.router.v3.Router</span>
              <span style=color:#a6e22e>route_config</span><span style=color:#fff;background-color:#272822>:</span>
                <span style=color:#a6e22e>virtual_hosts</span><span style=color:#fff;background-color:#272822>:</span>
                  <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>name</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>direct_response_service</span>
                    <span style=color:#a6e22e>domains</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#fff;background-color:#272822>[</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>*&#34;</span><span style=color:#fff;background-color:#272822>]</span>
                    <span style=color:#a6e22e>routes</span><span style=color:#fff;background-color:#272822>:</span>
                      <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>match</span><span style=color:#fff;background-color:#272822>:</span>
                          <span style=color:#a6e22e>prefix</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>/&#34;</span>
                        <span style=color:#a6e22e>route</span><span style=color:#fff;background-color:#272822>:</span>
                          <span style=color:#a6e22e>cluster</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>services</span>

  <span style=color:#a6e22e>clusters</span><span style=color:#fff;background-color:#272822>:</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>name</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>ext-authz</span>
      <span style=color:#a6e22e>type</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>strict_dns</span>
      <span style=color:#a6e22e>load_assignment</span><span style=color:#fff;background-color:#272822>:</span>
        <span style=color:#a6e22e>cluster_name</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>ext-authz</span>
        <span style=color:#a6e22e>endpoints</span><span style=color:#fff;background-color:#272822>:</span>
          <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>lb_endpoints</span><span style=color:#fff;background-color:#272822>:</span>
              <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>endpoint</span><span style=color:#fff;background-color:#272822>:</span>
                  <span style=color:#a6e22e>address</span><span style=color:#fff;background-color:#272822>:</span>
                    <span style=color:#a6e22e>socket_address</span><span style=color:#fff;background-color:#272822>:</span>
                      <span style=color:#a6e22e>address</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>heimdall</span>
                      <span style=color:#a6e22e>port_value</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#ae81ff>4456</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>name</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>services</span>
      <span style=color:#a6e22e>connect_timeout</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>5s</span>
      <span style=color:#a6e22e>type</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>strict_dns</span>
      <span style=color:#a6e22e>dns_lookup_family</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>V4_ONLY</span>
      <span style=color:#a6e22e>load_assignment</span><span style=color:#fff;background-color:#272822>:</span>
        <span style=color:#a6e22e>cluster_name</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>services</span>
        <span style=color:#a6e22e>endpoints</span><span style=color:#fff;background-color:#272822>:</span>
          <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>lb_endpoints</span><span style=color:#fff;background-color:#272822>:</span>
              <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>endpoint</span><span style=color:#fff;background-color:#272822>:</span>
                  <span style=color:#a6e22e>address</span><span style=color:#fff;background-color:#272822>:</span>
                    <span style=color:#a6e22e>socket_address</span><span style=color:#fff;background-color:#272822>:</span>
                      <span style=color:#a6e22e>address</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>upstream</span>
                      <span style=color:#a6e22e>port_value</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>80</span></code></pre></div></div><div class=paragraph><p>After starting the docker compose environment, you can run the curl commands shown in the referenced guide. This time however against envoy by using port 9090. E.g. <code>$ curl -v 127.0.0.1:9090/anonymous</code>. By the way, this setup is also available on <a href=https://github.com/dadrus/heimdall/tree/main/examples/docker-compose/quickstarts>GitHub</a>.</p></div></div></div></div><p class="text-end fst-italic fs-7">Last updated on <span class=fw-bold>Mar 6, 2023</span></p><div class="d-flex justify-content-between"><a href=../../../docs/guides/nginx/><div class="fs-6 mb-3"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-chevron-left" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.354 1.646a.5.5.0 010 .708L5.707 8l5.647 5.646a.5.5.0 01-.708.708l-6-6a.5.5.0 010-.708l6-6a.5.5.0 01.708.0z"/></svg>NGINX Integration</div></a><a class=ms-auto href=../../../docs/guides/opa/><div class="fs-6 mb-3">Integration with OPA<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-chevron-right" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5.0 01.708.0l6 6a.5.5.0 010 .708l-6 6a.5.5.0 01-.708-.708L10.293 8 4.646 2.354a.5.5.0 010-.708z"/></svg></div></a></div></main></div><footer class="footer py-4 py-md-5 px-4 px-md-3"><div class=container><div class=row><div class="col-lg-3 mb-3"><p class=fs-5>Heimdall</p><ul class="list-unstyled small text-muted"><li class=mb-2>2022 © Heimdall Project Authors. All rights reserved.</li><li class=mb-2><a href=https://github.com/dadrus/heimdall/blob/master/LICENSE>Apache 2.0 licensed</a></li></ul></div><div class="col-6 col-lg-2 offset-lg-1 mb-3"><h5>Links</h5><ul class=list-unstyled><li class=mb-2><a href=../../../>Home</a></li><li class=mb-2><a href=../../../docs/welcome>Docs</a></li><li class=mb-2><a href=../../../openapi/>API</a></li><li class=mb-2><a href=../../../docs/getting_started/concepts/>Get Started</a></li></ul></div><div class="col-6 col-lg-2 mb-2"><h5>Guides</h5><ul class=list-unstyled><li class=mb-2><a href=../../../docs/operations/install/>Install</a></li><li class=mb-2><a href=../../../docs/guides/nginx/>NGINX Integration</a></li><li class=mb-2><a href=../../../docs/guides/traefik/>Traefik Proxy Integration</a></li><li class=mb-2><a href=../../../docs/guides/contour/>Contour Integration</a></li><li class=mb-2><a href=../../../docs/guides/envoy/>Envoy Integration</a></li><li class=mb-2><a href=../../../docs/guides/opa/>Integration with OPA</a></li></ul></div><div class="col-6 col-lg-2 mb-2"><h5>Community</h5><ul class=list-unstyled><li class=mb-2><a href=https://github.com/dadrus/heimdall>Github</a></li><li class=mb-2><a href=https://github.com/dadrus/heimdall/issues>Issues</a></li><li class=mb-2><a href=https://github.com/dadrus/heimdall/discussions>Discussions</a></li></ul></div></div></div></footer><script src=../../../js/main.js defer></script>
<script src=https://cdn.redoc.ly/redoc/latest/bundles/redoc.standalone.js></script></body></html>