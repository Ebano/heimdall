<!doctype html><html><head><title>Rule Definition</title><meta charset=utf-8><meta name=description content="Website meta description for google search results go here"><meta name=dc.relation content="https://dadrus.github.io/"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=theme-color content="#1A94D2"><link rel=stylesheet href=../../../../css/styles.min.css media=screen><link rel='shortcut icon' type=image/x-icon href=../../../../favicon.ico></head><body><nav class="navbar navbar-expand-lg navbar-light bg-dark fixed-top"><div class=container><a class="navbar-brand text-white" href=../../../../>Heimdall</a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class=nav-item><a class='text-white nav-link' href=../../../../docs/introduction/architecture>Docs</a></li><li class=nav-item><a class='text-white nav-link' href=../../../../docs/api/>API</a></li><li class="nav-item dropdown"><a class='text-white nav-link dropdown-toggle' href=# id="Get Started-navbarDropdown" role=button data-bs-toggle=dropdown aria-expanded=false>Get Started</a><ul class=dropdown-menu aria-labelledby="Get Started-navbarDropdown"><li><a class=dropdown-item href=../../../../docs/introduction/install/>Install</a></li><li><a class=dropdown-item href=../../../../docs/introduction/quickstart/>Quickstart</a></li></ul></li></ul><a class=d-flex href=https://github.com/dadrus/heimdall><svg xmlns="http://www.w3.org/2000/svg" role="img" width="20" height="20" fill="currentcolor" class="bi bi-github text-white" viewBox="0 0 16 16"><title>GitHub</title><path d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.012 8.012.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a></div></div></nav><div id=content class=container><div class=row><div class=col-3><ul class="nav flex-column"><li class=nav-item><span class=nav-link>Introduction</span><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../../docs/introduction/architecture/>Architecture</a></li><li class=nav-item><a class=nav-link href=../../../../docs/introduction/install/>Install</a></li><li class=nav-item><a class=nav-link href=../../../../docs/introduction/quickstart/>Quickstart</a></li><li class=nav-item><a class=nav-link href=../../../../docs/introduction/from_source/>Install from Source</a></li></ul></li><li class=nav-item><a class=nav-link href=../../../../docs/configuration/>Configuration</a><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../../docs/configuration/services/>Services</a><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../../docs/configuration/services/decision_api/>Decision API</a></li><li class=nav-item><a class=nav-link href=../../../../docs/configuration/services/proxy/>Proxy</a></li></ul></li><li class=nav-item><a class=nav-link href=../../../../docs/configuration/observability/>Observability</a><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../../docs/configuration/observability/logging/>Logging</a></li><li class=nav-item><a class=nav-link href=../../../../docs/configuration/observability/metrics/>Metrics</a></li><li class=nav-item><a class=nav-link href=../../../../docs/configuration/observability/tracing/>Tracing</a></li></ul></li><li class=nav-item><a class=nav-link href=../../../../docs/configuration/pipeline/>Pipeline Handler</a><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../../docs/configuration/pipeline/authenticators/>Authenticators</a></li><li class=nav-item><a class=nav-link href=../../../../docs/configuration/pipeline/authorizers/>Authorizers</a></li><li class=nav-item><a class=nav-link href=../../../../docs/configuration/pipeline/hydrators/>Hydrators</a></li><li class=nav-item><a class=nav-link href=../../../../docs/configuration/pipeline/mutators/>Mutators</a></li><li class=nav-item><a class=nav-link href=../../../../docs/configuration/pipeline/error_handlers/>Error Handlers</a></li><li class=nav-item><a class=nav-link href=../../../../docs/configuration/pipeline/configuration_types/>Configuration Types</a></li></ul></li><li class=nav-item><a class=nav-link href=../../../../docs/configuration/rules/>Rules</a><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../../docs/configuration/rules/default_rule/>Default Rule</a></li><li class=nav-item><a class=nav-link href=../../../../docs/configuration/rules/rule_definition/>Rule Definition</a></li><li class=nav-item><a class=nav-link href=../../../../docs/configuration/rules/providers/>Providers</a></li></ul></li><li class=nav-item><a class=nav-link href=../../../../docs/configuration/reference/>Reference</a><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../../docs/configuration/reference/configuration/>Static Configuration</a></li></ul></li></ul></li><li class=nav-item><span class=nav-link>Guides</span><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../../docs/guides/traefik/>Traefik Proxy Integration</a></li></ul></li></ul></div><div class=col-9><h1>Rule Definition</h1><div><h2 id=rule-configuration>Rule Configuration</h2><p>A single rule consists of the following properties:</p><table><thead><tr><th>Name</th><th>Type</th><th>Mandatory</th><th>Description</th></tr></thead><tbody><tr><td><code>id</code></td><td><em>string</em></td><td>yes</td><td>The unique identifier of a rule. It must be unique across all rules. To ensure this it is recommended to let the <code>id</code> include the name of your upstream service, as well as its purpose. E.g. <code>rule:my-service:public-api</code>.</td></tr><tr><td><code>url</code></td><td><em>string</em></td><td>yes</td><td>Glob or Regex pattern of the endpoints of your upstream service, which this rule should apply to. Query parameters are ignored.</td></tr><tr><td><code>matching_strategy</code></td><td><em><a href=#matching-strategy>Matching Strategy</a></em></td><td>no</td><td>Which strategy to use for matching of the value, provided in the <code>url</code> property. Can be <code>glob</code> or <code>regex</code>. Defaults to <code>glob</code>.</td></tr><tr><td><code>methods</code></td><td><em>string</em></td><td>no</td><td>Which HTTP methods (<code>GET</code>, <code>POST</code>, <code>PATCH</code>, etc) are allowed for the matched url.</td></tr><tr><td><code>execute</code></td><td><em><a href=#regular-pipeline>Regular Pipeline</a></em></td><td>yes</td><td>Which handlers to use to authenticate, authorize, hydrate (enrich) and mutate the subject of the request.</td></tr><tr><td><code>on_error</code></td><td><em><a href=#error-handler-pipeline>Error Handler Pipeline</a></em></td><td>no</td><td>Which error handlers to use if any of the handlers, defined in the <code>execute</code> property, fails. This property is optional only, if a <a href=../../../../docs/configuration/rules/default_rule/>default rule</a> has been configured and contains an <code>on_error</code> definition.</td></tr></tbody></table><p><strong>Example</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>id</span>: <span style=color:#ae81ff>rule:foo:bar</span>
</span></span><span style=display:flex><span><span style=color:#f92672>url</span>: <span style=color:#ae81ff>http://my-service.local/&lt;**&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>methods</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>GET</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>POST</span>
</span></span><span style=display:flex><span><span style=color:#f92672>execute</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>authenticator</span>: <span style=color:#ae81ff>foo</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>authorizer</span>: <span style=color:#ae81ff>bar</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>hydrator</span>: <span style=color:#ae81ff>foo</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>mutator</span>: <span style=color:#ae81ff>zab</span>
</span></span><span style=display:flex><span><span style=color:#f92672>on_error</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>error_handler</span>: <span style=color:#ae81ff>foobar</span>
</span></span></code></pre></div><h3 id=matching-strategy>Matching Strategy</h3><p>Heimdall uses <a href=https://github.com/dlclark/regexp2>dlclark/regexp2</a> to match <code>regex</code> expressions and <a href=https://github.com/gobwas/glob>gobwas/glob</a> to match <code>glob</code> expressions. Head over to linked resources to get more insights about possible options for expression definitions.</p><p><strong>Regular expressions examples</strong></p><ul><li><code>https://mydomain.com/</code> matches <code>https://mydomain.com/</code> and doesn&rsquo;t match <code>https://mydomain.com/foo</code> or <code>https://mydomain.com</code>.</li><li><code>&lt;https|http>://mydomain.com/&lt;.*></code> matches <code>https://mydomain.com/</code> and <code>http://mydomain.com/foo</code>. Doesn&rsquo;t match <code>https://other-domain.com/</code> or <code>https://mydomain.com</code>.</li><li><code>http://mydomain.com/&lt;[[:digit:]]+></code> matches <code>http://mydomain.com/123</code>, but doesn&rsquo;t match <code>http://mydomain/abc</code>.</li><li><code>http://mydomain.com/&lt;(?!protected).*></code> matches <code>http://mydomain.com/resource</code>, but doesn&rsquo;t match <code>http://mydomain.com/protected</code>.</li></ul><p><strong>Glob patterns examples</strong></p><ul><li><code>https://mydomain.com/&lt;m?n></code> matches <code>https://mydomain.com/man</code> and does not match <code>http://mydomain.com/foo</code>.</li><li><code>https://mydomain.com/&lt;{foo*,bar*}></code> matches <code>https://mydomain.com/foo</code> or <code>https://mydomain.com/bar</code> and doesn&rsquo;t match <code>https://mydomain.com/any</code>.</li></ul><h3 id=regular-pipeline>Regular Pipeline</h3><p>As described in the <a href=../../../../docs/introduction/architecture/>Architecture Overview</a>, Heimdall&rsquo;s decision pipeline consists of multiple steps - at least consisting of <a href=../../../../docs/configuration/pipeline/authenticators/>authenticators</a> and <a href=../../../../docs/configuration/pipeline/mutators/>mutators</a>. The definition of such a pipeline happens as a list of required types with the corresponding ids (previously defined in Heimdall&rsquo;s <a href=../../../../docs/configuration/pipeline/>Pipeline</a> configuration), in the following order:</p><ul><li>List of <a href=../../../../docs/configuration/pipeline/authenticators/>authenticators</a> using <code>authenticator</code> as key, followed by the required authenticator <code>id</code>. Authenticators following the first defined in the list are used by Heimdall as fallback. That is, if first authenticator fails due to missing authentication data, second is executed, etc. Fallback is not used if an authenticator fails due to validation errors of the given authentication data. E.g. if an authenticator fails to validate the signature of a JWT token, the next authenticator in the list will not be executed. Instead, the entire pipeline will fail and lead to the execution of the <a href=#error-handler-pipeline>error handler pipeline</a>. This list is mandatory if no <a href=../../../../docs/configuration/rules/default_rule/>default rule</a> is configured.</li><li>List of <a href=../../../../docs/configuration/pipeline/hydrators/>hydrators</a> and <a href=../../../../docs/configuration/pipeline/authorizers/>authorizers</a> in any order (optional). Can also be mixed. As with authenticators, the list definition happens using either <code>hydrator</code> or <code>authorizer</code> as key, followed by the required <code>id</code>. All handlers in this list are executed in the order, they are defined. If any of these fails, the entire pipeline fails, which leads to the execution of the <a href=#error-handler-pipeline>error handler pipeline</a>. This list is optional.</li><li>List <a href=../../../../docs/configuration/pipeline/mutators/>mutators</a> using <code>mutator</code> as key, followed by the required mutator <code>id</code>. All mutators in this list are executed in the order, they are defined. If any of these fails, the entire pipeline fails, which leads to the execution of the <a href=#error-handler-pipeline>error handler pipeline</a>. This list is mandatory if no <a href=../../../../docs/configuration/rules/default_rule/>default rule</a> is configured.</li></ul><p>In all cases, parts of the used pipeline type configurations can be overridden if supported by the corresponding pipeline type. Overriding has no effect on the handler prototypes defined in Heimdall&rsquo;s <a href=../../../../docs/configuration/pipeline/>Pipeline</a> configuration. Overrides are always local to the given rule. With other words, you can adjust your rule specific pipeline as you want without any side effects.</p><p><strong>Example</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># list of authenticators</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>authenticator</span>: <span style=color:#ae81ff>foo</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>authenticator</span>: <span style=color:#ae81ff>bar</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>config</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>subject</span>: <span style=color:#ae81ff>anon</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># ... any further required authenticator</span>
</span></span><span style=display:flex><span><span style=color:#75715e># list of authorizers and hydrators in any order</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>hydrator</span>: <span style=color:#ae81ff>baz</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>config</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>cache_ttl</span>: <span style=color:#ae81ff>0s</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>authorizer</span>: <span style=color:#ae81ff>zab</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>hydrator</span>: <span style=color:#ae81ff>foo</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>hydrator</span>: <span style=color:#ae81ff>bar</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>authorizer</span>: <span style=color:#ae81ff>foo</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>config</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>script</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      </span>      <span style=color:#ae81ff>// some script logic deviating from the definition in the pipeline configuration.</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># ... any further required authorizer or hydrator</span>
</span></span><span style=display:flex><span><span style=color:#75715e># list of mutators</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>mutator</span>: <span style=color:#ae81ff>foo</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>mutator</span>: <span style=color:#ae81ff>bar</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>config</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>headers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>X-User-ID</span>: {{ <span style=color:#ae81ff>quote .ID }}</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># ... any further required mutators</span>
</span></span></code></pre></div><p>This example uses</p><ul><li>two authenticators, with authenticator named <code>bar</code> being the fallback for the authenticator named <code>foo</code>. This fallback authenticator is obviously of type <a href=../../../../docs/configuration/pipeline/authenticators/#anonymous>anonymous</a> as it reconfigures the referenced prototype to use <code>anon</code> for subject id.</li><li>multiple hydrators and authorizers, with first hydrator having its cache disabled (<code>cache_ttl</code> set to 0s) and the last authorizer being of type <a href=../../../../docs/configuration/pipeline/authorizers/#local>local</a> as it reconfigures the referenced prototype to use a different authorization script.</li><li>two mutators, with the second one being obviously of type <a href=../../../../docs/configuration/pipeline/mutators/#header>header</a>, as it defines a <code>X-User-ID</code> header set to the value of the subject id to be forwarded to the upstream service.</li></ul><h3 id=error-handler-pipeline>Error Handler Pipeline</h3><p>Compared to the <a href=#regular-pipeline>Regular Pipeline</a>, the error handler pipeline is pretty simple. It is also a list of handlers, but all referenced handler types are <a href=../../../../docs/configuration/pipeline/error_handlers/>error handler types</a>. Thus, each entry in this list must have <code>error_handler</code> as key, followed by the <code>ìd</code> of the required error handler, previously defined in Heimdall&rsquo;s <a href=../../../../docs/configuration/pipeline/>Pipeline</a> configuration. Error handlers are always executed as fallbacks. So, if the condition of the first error handler does not match, second is selected, if its condition matches, it is executed, otherwise the next one is selected, etc. If none of the conditions of the defined error handlers match, the <a href=../../../../docs/configuration/pipeline/error_handlers/#default>default error handler</a> is executed.</p><p>As with the regular pipeline, parts of the used error handler configurations can be overridden if supported by the corresponding type. Overriding has no effect on the handler prototypes defined in Heimdall&rsquo;s <a href=../../../../docs/configuration/pipeline/>Pipeline</a> configuration. Overrides are always local to the given rule. With other words, you can adjust your rule specific pipeline as you want without any side effects.</p><p><strong>Example</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>error_handler</span>: <span style=color:#ae81ff>foo</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>error_handler</span>: <span style=color:#ae81ff>bar</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>config</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>when</span>:
</span></span><span style=display:flex><span>      <span style=color:#75715e># rule specific conditions</span>
</span></span></code></pre></div><p>This example uses two error handlers, named <code>foo</code> and <code>bar</code>. <code>bar</code> will only be selected by Heimdall if <code>foo</code>&rsquo;s error condition (defined in Heimdall&rsquo;s <a href=../../../../docs/configuration/pipeline/>Pipeline</a> configuration) does not match. <code>bar</code> does also override the default condition, defined by the prototype to the one required, by the given rule.</p><h2 id=rule-set>Rule Set</h2><p>A rule set is just a list of rules, typically defined in a format specified by a particular <a href=../../../../docs/configuration/rules/providers/>provider</a>. In its simplest case, a rule set does not require further configuration options and can look like shown below:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>id</span>: <span style=color:#ae81ff>rule:1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>url</span>: <span style=color:#ae81ff>https://my-service1.local/&lt;**&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>methods</span>: [ <span style=color:#e6db74>&#34;GET&#34;</span> ]
</span></span><span style=display:flex><span>  <span style=color:#f92672>execute</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>authorizer</span>: <span style=color:#ae81ff>foobar</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>id</span>: <span style=color:#ae81ff>rule:2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>url</span>: <span style=color:#ae81ff>https://my-service2.local/&lt;**&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>methods</span>: [ <span style=color:#e6db74>&#34;GET&#34;</span> ]
</span></span><span style=display:flex><span>  <span style=color:#f92672>execute</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>authorizer</span>: <span style=color:#ae81ff>barfoo</span>
</span></span><span style=display:flex><span><span style=color:#75715e># further rules</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span></code></pre></div></div></div></div></div><footer class="footer py-4 py-md-5 px-4 px-md-3"><div class=container><div class=row><div class="col-lg-3 mb-3"><p class=fs-5>Heimdall</p><ul class="list-unstyled small text-muted"><li class=mb-2>2022 © Heimdall Project Authors. All rights reserved.</li><li class=mb-2><a href=https://github.com/dadrus/heimdall/blob/master/LICENSE>Apache 2.0 licensed</a></li></ul></div><div class="col-6 col-lg-2 offset-lg-1 mb-3"><h5>Links</h5><ul class=list-unstyled><li class=mb-2><a href=../../../../>Home</a></li><li class=mb-2><a href=../../../../>Docs</a></li></ul></div><div class="col-6 col-lg-2 mb-2"><h5>Guides</h5><ul class=list-unstyled><li class=mb-2><a href=../../../../>Install</a></li><li class=mb-2><a href=../../../../>Getting Started</a></li></ul></div><div class="col-6 col-lg-2 mb-2"><h5>Community</h5><ul class=list-unstyled><li class=mb-2><a href=https://github.com/dadrus/heimdall>Github</a></li><li class=mb-2><a href=https://github.com/dadrus/heimdall/issues>Issues</a></li><li class=mb-2><a href=https://github.com/dadrus/heimdall/discussions>Discussions</a></li></ul></div></div></div><script src=../../../../js/bundle.min.js defer></script></footer></body></html>